@startuml
'=================================================
' WEEK 12 PRACTICE â€” BACKFILL & INCREMENTAL REASONING
'=================================================

top to bottom direction
skinparam linetype ortho
skinparam shadowing false
skinparam roundcorner 8
skinparam handwritten false
skinparam nodesep 30
skinparam ranksep 40

skinparam defaultFontName "Segoe UI", "Helvetica", sans-serif
skinparam defaultFontSize 16
skinparam defaultFontColor #2C3E50
skinparam rectangle { BackgroundColor #F8F9FA; BorderColor #90A4AE; BorderThickness 2; FontColor #263238; FontSize 14; FontStyle bold; Padding 20 }
skinparam component { BackgroundColor #FFFFFF; BorderColor #78909C; BorderThickness 1.5; FontSize 14; Padding 12 }
skinparam database { BackgroundColor #ECEFF1; BorderColor #546E7A; BorderThickness 1.5; FontSize 14; FontColor #263238 }
skinparam arrow { Color #607D8B; Thickness 1.5; FontSize 11; FontColor #546E7A }
skinparam component<<Tool>> { BorderColor #2E7D32; BackgroundColor #E8F5E9; FontColor #1B5E20 }
skinparam component<<Agent>> { BorderColor #0288D1; BackgroundColor #E1F5FE; FontColor #01579B }

'========================
' BACKFILL vs INCREMENTAL DECISION
'========================

rectangle "INPUTS" #F8F9FA {
    database "**events**\n<size:10>partitioned by date</size>" as EVT
    component "**control**\n<size:10>last_as_of_ts</size>" as CTRL <<Agent>>
}

rectangle "DECISION" #F8F9FA {
    component "**Backfill?**\n<size:10>Full range [d_start, d_end]</size>" as BACKFILL <<Tool>>
    component "**Incremental?**\n<size:10>Only last_as_of_ts + 1 day</size>" as INCR <<Tool>>
}

rectangle "WRITE" #F8F9FA {
    component "**Overwrite partition**\n<size:10>per as_of_ts</size>" as WRITE <<Agent>>
    database "**user_features**\n<size:10>key (user_id, as_of_ts)</size>" as FT
}

EVT --> BACKFILL
EVT --> INCR
CTRL --> INCR
BACKFILL --> WRITE
INCR --> WRITE
WRITE --> FT

note bottom of WRITE : **Idempotent:** same partition overwritten; rerun = same result.
note bottom of FT : **No overlap:** one job owns each partition; control updated after success.

@enduml
