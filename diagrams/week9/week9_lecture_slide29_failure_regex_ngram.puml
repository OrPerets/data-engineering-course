@startuml
'=================================================
' Week 9: Failure — Regex backtracking & hot n-gram
'=================================================

top to bottom direction
skinparam linetype ortho
skinparam shadowing false
skinparam roundcorner 8
skinparam defaultFontName "Segoe UI", "Helvetica", sans-serif
skinparam defaultFontSize 16
skinparam defaultFontColor #2C3E50
skinparam rectangle { BackgroundColor #F8F9FA; BorderColor #90A4AE; BorderThickness 2 }
skinparam component { BackgroundColor #FFFFFF; BorderColor #78909C; BorderThickness 1.5 }
skinparam arrow { Color #607D8B; Thickness 1.5 }

rectangle "FAILURE 1: Regex" #F8F9FA {
    component "**Greedy regex**\n(a+)+b on \"aaa...\"\n<size:10>Catastrophic backtracking → CPU spike, timeout</size>" as REGEX
}

rectangle "FAILURE 2: N-gram skew" #F8F9FA {
    component "**Partition by ngram**\nCommon n-gram (e.g. \"the_and\") in most docs\n<size:10>One reducer gets most (ngram, doc_id) → OOM</size>" as SKEW
}

rectangle "MITIGATION" #F8F9FA {
    component "**Regex:** non-backtracking engine or simplify pattern; timeout per record" as M1
    component "**Skew:** filter stop-ngrams; partition by (doc_id, ngram) not ngram alone" as M2
}

REGEX --> M1
SKEW --> M2

note bottom of REGEX : Use possessive/atomic groups or avoid nested quantifiers on untrusted input.

@enduml
